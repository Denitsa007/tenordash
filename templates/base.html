<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}TenorDash{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Dynamic currency colors from DB -->
  <style>
    :root {
      {% for curr in currencies %}
      --{{ curr.code|lower }}: {{ curr.css_color }};
      {% endfor %}
    }
    {% for curr in currencies %}
    .badge-{{ curr.code|lower }} { background: {{ curr.css_color }}18; color: {{ curr.css_color }}; }
    .text-{{ curr.code|lower }} { color: {{ curr.css_color }}; }
    .card-value.{{ curr.code|lower }} { color: {{ curr.css_color }}; }
    .util-bar-fill.{{ curr.code|lower }} { background: {{ curr.css_color }}; }
    {% endfor %}
  </style>
</head>
<body>
  <nav class="sidebar">
    <div class="sidebar-logo">
      TenorDash
      <small>Treasury Management</small>
    </div>
    <a href="/" class="nav-item {{ 'active' if active_page == 'dashboard' }}">
      <svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>
      Dashboard
      {% if alert_count is defined and alert_count > 0 %}
        <span class="nav-badge">{{ alert_count }}</span>
      {% endif %}
    </a>
    <a href="/advances" class="nav-item {{ 'active' if active_page == 'advances' }}">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2 3h12v2H2zm0 4h12v2H2zm0 4h8v2H2z"/></svg>
      Fixed Advances
    </a>
    <a href="/credit-lines" class="nav-item {{ 'active' if active_page == 'credit_lines' }}">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M3 2a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V3a1 1 0 00-1-1H3zm1 2h8v2H4V4z"/></svg>
      Credit Lines
    </a>
    <a href="/banks" class="nav-item {{ 'active' if active_page == 'banks' }}">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1L1 5v1h14V5L8 1zM3 7v5h2V7H3zm4 0v5h2V7H7zm4 0v5h2V7h-2zM1 13v2h14v-2H1z"/></svg>
      Banks
    </a>
    <a href="#" class="nav-item" onclick="openSettingsModal(); return false;">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 10a2 2 0 100-4 2 2 0 000 4zm6.32-1.906l-1.066-.616a5.21 5.21 0 000-1.956l1.066-.616a.5.5 0 00.183-.683l-1-1.732a.5.5 0 00-.683-.183l-1.066.616a5.163 5.163 0 00-1.694-.978V1.5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1.232a5.163 5.163 0 00-1.694.978L4.3 3.094a.5.5 0 00-.683.183l-1 1.732a.5.5 0 00.183.683l1.066.616a5.21 5.21 0 000 1.956l-1.066.616a.5.5 0 00-.183.683l1 1.732a.5.5 0 00.683.183l1.066-.616c.502.42 1.075.748 1.694.978V14.5a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-1.232a5.163 5.163 0 001.694-.978l1.066.616a.5.5 0 00.683-.183l1-1.732a.5.5 0 00-.183-.683z"/></svg>
      Settings
    </a>
    {% if fx_rates is defined and fx_rates %}
    <div class="ecb-footer sidebar-ecb">
      {% for curr in currencies %}
        {% if curr.code != BASE_CURRENCY and fx_rates.get(curr.code) %}
          <div>{{ curr.code }}/{{ BASE_CURRENCY }}: {{ "%.4f"|format(fx_rates[curr.code]) }}</div>
        {% endif %}
      {% endfor %}
      <div class="ecb-source">Source: ECB {{ ecb_date or '' }}</div>
    </div>
    {% endif %}
    <div class="nav-spacer"></div>
    <div class="sidebar-monogram">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="ds" title="Created by Denitsa Stachowski" />
      <a href="https://denitsa.ch" target="_blank" class="sidebar-link">denitsa.ch</a>
    </div>
  </nav>

  <main class="main">
    {% block content %}{% endblock %}
  </main>

  <!-- Print-only FX rates footer (hidden on screen, shown on print) -->
  {% if fx_rates is defined and fx_rates %}
  <div class="print-fx-footer">
    {% for curr in currencies %}
      {% if curr.code != BASE_CURRENCY and fx_rates.get(curr.code) %}
        <span>{{ curr.code }}/{{ BASE_CURRENCY }}: {{ "%.4f"|format(fx_rates[curr.code]) }}</span>
      {% endif %}
    {% endfor %}
    <span class="print-fx-source">Source: ECB {{ ecb_date or '' }}</span>
  </div>
  {% endif %}

  <!-- Add Currency Modal (shared across all pages) -->
  <div class="modal-overlay" id="currency-modal">
    <div class="modal-box">
      <h3>
        Add Currency
        <button class="panel-close" onclick="closeCurrencyModal()">&times;</button>
      </h3>
      <form id="currency-form" onsubmit="saveCurrency(event)">
        <div class="form-group">
          <label>Currency Code (3 letters)</label>
          <input type="text" id="currency-code" maxlength="3" pattern="[A-Za-z]{3}" required
                 placeholder="e.g. JPY" style="text-transform: uppercase;" autocomplete="off" />
        </div>
        <div class="currency-msg" id="currency-msg" style="display:none"></div>
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeCurrencyModal()">Cancel</button>
          <button type="submit" class="btn-primary" id="currency-submit-btn">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2 7 5.5 10.5 12 4"/></svg>
            Add
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal-box" style="width: 480px;">
      <h3>
        Settings
        <button class="panel-close" onclick="closeSettingsModal()">&times;</button>
      </h3>
      <form id="settings-form" onsubmit="saveSettings(event)">
        <div class="form-group">
          <label>Display Unit</label>
          <select id="settings-display-unit">
            <option value="full">Full (80,000,000)</option>
            <option value="thousands">Thousands (80,000K)</option>
            <option value="millions">Millions (80M)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Continuations to show</label>
          <select id="settings-continuation-limit">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="all">All</option>
          </select>
        </div>
        <div class="form-group">
          <label>Export Path</label>
          <div style="display:flex; gap:8px;">
            <input type="text" id="settings-export-path"
                   placeholder="/path/to/export/folder" style="flex:1;" />
            <button type="button" class="btn-secondary" id="browse-btn"
                    onclick="openFolderBrowser()">Browse</button>
          </div>
          <div id="folder-browser" style="display:none;">
            <div class="folder-breadcrumb" id="folder-breadcrumb"></div>
            <div class="folder-list" id="folder-list"></div>
            <div class="folder-actions">
              <span class="folder-status" id="folder-status"></span>
              <button type="button" class="btn-primary btn-sm" id="folder-select-btn"
                      onclick="selectFolder()">Select this folder</button>
            </div>
          </div>
          <div class="form-hint" style="color: var(--text-light);">Directory where .xlsx exports are saved</div>
        </div>
        <div class="currency-msg" id="settings-msg" style="display:none"></div>
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeSettingsModal()">Cancel</button>
          <button type="submit" class="btn-primary" id="settings-submit-btn">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2 7 5.5 10.5 12 4"/></svg>
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
  <script>
  function openCurrencyModal() {
    document.getElementById('currency-form').reset();
    document.getElementById('currency-msg').style.display = 'none';
    document.getElementById('currency-submit-btn').disabled = false;
    document.getElementById('currency-modal').classList.add('show');
    document.getElementById('currency-code').focus();
  }

  function closeCurrencyModal() {
    document.getElementById('currency-modal').classList.remove('show');
  }

  async function saveCurrency(e) {
    e.preventDefault();
    const code = document.getElementById('currency-code').value.trim().toUpperCase();
    const msgEl = document.getElementById('currency-msg');
    const btn = document.getElementById('currency-submit-btn');
    btn.disabled = true;
    msgEl.style.display = 'none';

    const res = await fetch('/api/currencies', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({code})
    });
    const data = await res.json();
    if (data.ok) {
      // Add new option to all currency dropdowns on the page (keeps form state)
      document.querySelectorAll('select[id$="-currency"]').forEach(sel => {
        if (!sel.querySelector('option[value="' + data.code + '"]')) {
          const opt = document.createElement('option');
          opt.value = data.code;
          opt.textContent = data.code;
          sel.appendChild(opt);
          sel.value = data.code;  // auto-select the newly added currency
        }
      });
      if (data.ecb_warning) {
        msgEl.textContent = data.ecb_warning + ' â€” currency added without ECB rates.';
        msgEl.className = 'currency-msg warn';
        msgEl.style.display = 'block';
        setTimeout(() => closeCurrencyModal(), 1200);
      } else {
        closeCurrencyModal();
      }
    } else {
      msgEl.textContent = data.error || 'Failed to add currency';
      msgEl.className = 'currency-msg error';
      msgEl.style.display = 'block';
      btn.disabled = false;
    }
  }

  // Close modals on overlay click or Escape
  document.getElementById('currency-modal').addEventListener('click', function(e) {
    if (e.target === this) closeCurrencyModal();
  });
  document.getElementById('settings-modal').addEventListener('click', function(e) {
    if (e.target === this) closeSettingsModal();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeCurrencyModal(); closeSettingsModal(); }
  });
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
