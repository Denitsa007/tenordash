{% extends "base.html" %}
{% set active_page = "advances" %}

{% block title %}Fixed Advances — TenorDash{% endblock %}

{% block content %}
<div class="topbar">
  <h2>Fixed Advances</h2>
  <div class="topbar-actions">
    <button class="btn-primary" onclick="openAdvForm()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="2" x2="7" y2="12"/><line x1="2" y1="7" x2="12" y2="7"/></svg>
      New Advance
    </button>
  </div>
</div>

<div class="section">
  <div class="section-header">
    <h3>All Advances ({{ advances|length }})</h3>
    <div class="filter-pills">
      <span class="pill active" data-filter="all" onclick="filterAdvances('all', this)">All</span>
      <span class="pill" data-filter="active" onclick="filterAdvances('active', this)">Active</span>
      {% for curr in currencies %}
      <span class="pill" data-filter="{{ curr.code }}" onclick="filterAdvances('{{ curr.code }}', this)">{{ curr.code }}</span>
      {% endfor %}
    </div>
  </div>
  <table class="data-table" id="advances-table">
    <thead>
      <tr>
        <th data-sort="id">ID <span class="sort-indicator"></span></th>
        <th data-sort="bank">Bank <span class="sort-indicator"></span></th>
        <th data-sort="credit_line">Credit Line <span class="sort-indicator"></span></th>
        <th data-sort="currency">Currency <span class="sort-indicator"></span></th>
        <th data-sort="amount" style="text-align:right">Amount <span class="sort-indicator"></span></th>
        <th data-sort="start">Start <span class="sort-indicator"></span></th>
        <th data-sort="end">End <span class="sort-indicator"></span></th>
        <th data-sort="continuation">Continuation <span class="sort-indicator"></span></th>
        <th data-sort="days" style="text-align:right">Days <span class="sort-indicator"></span></th>
        <th data-sort="rate" style="text-align:right">Rate p.a. <span class="sort-indicator"></span></th>
        <th>Status</th>
        <th style="text-align:right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for adv in advances %}
      <tr data-id="{{ adv.id }}" data-currency="{{ adv.currency }}" data-active="{{ 'true' if adv.active else 'false' }}">
        <td class="mono text-muted">{{ adv.id }}</td>
        <td>{{ adv.bank }}</td>
        <td class="text-muted">{{ adv.credit_line_id }}</td>
        <td><span class="badge badge-{{ adv.currency|lower }}">{{ adv.currency }}</span></td>
        <td class="mono text-right text-{{ adv.currency|lower }}" data-sort-value="{{ adv.amount_original }}">{{ adv.amount_original|amount }}</td>
        <td data-sort-value="{{ adv.start_date }}">{{ adv.start_date|date_display }}</td>
        <td data-sort-value="{{ adv.end_date }}">{{ adv.end_date|date_display }}</td>
        <td data-sort-value="{{ adv.continuation_date }}">{{ adv.continuation_date|date_display }}</td>
        <td class="mono text-right" data-sort-value="{{ adv.days }}">{{ adv.days }}</td>
        <td class="mono text-right" data-sort-value="{{ adv.rate_pa }}">{{ adv.rate_pa|rate }}</td>
        <td><span class="badge {{ 'badge-active' if adv.active else 'badge-expired' }}">{{ 'Active' if adv.active else 'Expired' }}</span></td>
        <td>
          <div class="row-actions">
            <button onclick="editAdv('{{ adv.id }}')" title="Edit">&#9998;</button>
            <button class="delete" onclick="deleteAdv('{{ adv.id }}')" title="Delete">&times;</button>
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="12">
          <div class="empty-state">
            <p>No fixed advances yet.</p>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Slide-out Panel -->
<div class="panel-overlay" id="adv-panel">
  <div class="slide-panel">
    <h3>
      <span id="adv-panel-title">New Fixed Advance</span>
      <button class="panel-close" onclick="closeAdvForm()">&times;</button>
    </h3>

    <!-- View mode -->
    <div id="adv-view" class="panel-view" style="display:none">
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">Bank</div>
          <div class="detail-value" id="adv-view-bank"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Credit Line</div>
          <div class="detail-value" id="adv-view-cl"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Currency</div>
          <div class="detail-value" id="adv-view-currency"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Amount</div>
          <div class="detail-value mono" id="adv-view-amount"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Interest Amount</div>
          <div class="detail-value mono" id="adv-view-interest"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Status</div>
          <div class="detail-value" id="adv-view-status"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Start Date</div>
          <div class="detail-value" id="adv-view-start"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">End Date</div>
          <div class="detail-value" id="adv-view-end"></div>
        </div>
        <div class="detail-item full-width">
          <div class="detail-label">Continuation Date</div>
          <div class="detail-value" id="adv-view-cont"></div>
        </div>
      </div>
      <div class="detail-calc">
        <div>
          <div class="calc-label">Days</div>
          <div class="calc-value" id="adv-view-days"></div>
        </div>
        <div>
          <div class="calc-label">Rate p.a.</div>
          <div class="calc-value" id="adv-view-rate"></div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeAdvForm()">Close</button>
        <button type="button" class="btn-primary" id="adv-view-edit-btn">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 1.5l2 2L4 12H2v-2z"/></svg>
          Edit
        </button>
      </div>
    </div>

    <!-- Edit mode -->
    <form id="adv-form" onsubmit="saveAdv(event)" style="display:none">
      <input type="hidden" id="adv-edit-id" value="" />

      <div class="form-row">
        <div class="form-group">
          <label>Bank</label>
          <select id="adv-bank" required>
            <option value="">Select bank...</option>
            {% for bank in banks %}
            <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Credit Line</label>
          <select id="adv-cl" required onchange="dismissClWarning()">
            <option value="">Select...</option>
            {% for cl in lines %}
            <option value="{{ cl.id }}">{{ cl.id }} — {{ cl.description or cl.bank_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Currency</label>
        <div class="select-with-add">
          <select id="adv-currency" required>
            {% for curr in currencies %}
            <option value="{{ curr.code }}">{{ curr.code }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn-add-currency" onclick="openCurrencyModal()" title="Add currency">+</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" id="adv-start" required />
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input type="date" id="adv-end" required onchange="suggestContinuation()" />
        </div>
      </div>

      <div class="form-group">
        <label>Continuation Date</label>
        <input type="date" id="adv-cont" required />
        <div class="form-hint" id="cont-hint" style="display:none">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="#0d7c5f"><circle cx="5" cy="5" r="4"/></svg>
          <span id="cont-hint-text"></span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Amount</label>
          <input type="text" id="adv-amount" required placeholder="e.g. 50,000,000" oninput="formatAmountField(this); updateCalcPreview(); dismissClWarning()" inputmode="numeric" />
        </div>
        <div class="form-group">
          <label>Interest Amount</label>
          <input type="text" id="adv-interest" required placeholder="e.g. 196,527.78" oninput="formatAmountField(this, true); updateCalcPreview()" inputmode="decimal" />
        </div>
      </div>

      <div class="calc-preview" id="calc-preview">
        <div>
          <div class="calc-label">Days</div>
          <div class="calc-value" id="calc-days">—</div>
        </div>
        <div>
          <div class="calc-label">Rate p.a. (calc)</div>
          <div class="calc-value" id="calc-rate">—</div>
        </div>
      </div>

      <div class="cl-warning" id="cl-warning" style="display:none">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="#A62152"><path d="M7 0a7 7 0 100 14A7 7 0 007 0zm0 3a1 1 0 011 1v3a1 1 0 01-2 0V4a1 1 0 011-1zm0 7a1 1 0 110 2 1 1 0 010-2z"/></svg>
        <span id="cl-warning-text"></span>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeAdvForm()">Cancel</button>
        <button type="submit" class="btn-primary">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2 7 5.5 10.5 12 4"/></svg>
          Save Advance
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const parseNum = window.TDNumber.parseLocaleNumber;

function formatAmountField(el, allowDecimals) {
  window.TDNumber.formatAmountInput(el, allowDecimals);
}

function setAmountField(id, value, allowDecimals) {
  const el = document.getElementById(id);
  if (allowDecimals) {
    el.value = parseFloat(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  } else {
    el.value = parseInt(value).toLocaleString();
  }
}

function dismissClWarning() {
  clWarningAcknowledged = false;
  document.getElementById('cl-warning').style.display = 'none';
}

function showAdvPanel(mode) {
  const view = document.getElementById('adv-view');
  const form = document.getElementById('adv-form');
  view.style.display = mode === 'view' ? 'block' : 'none';
  form.style.display = mode === 'edit' ? 'block' : 'none';
}

function openAdvForm() {
  document.getElementById('adv-panel-title').textContent = 'New Fixed Advance';
  document.getElementById('adv-form').reset();
  document.getElementById('adv-edit-id').value = '';
  document.getElementById('cont-hint').style.display = 'none';
  document.getElementById('calc-days').textContent = '—';
  document.getElementById('calc-rate').textContent = '—';
  dismissClWarning();
  showAdvPanel('edit');
  document.getElementById('adv-panel').classList.add('show');
}

function closeAdvForm() {
  document.getElementById('adv-panel').classList.remove('show');
}

let currentViewAdvId = null;

async function viewAdv(id) {
  const res = await fetch('/advances/' + id);
  if (!res.ok) return;
  const d = await res.json();
  currentViewAdvId = id;

  document.getElementById('adv-panel-title').textContent = id;
  document.getElementById('adv-view-bank').textContent = d.bank;
  document.getElementById('adv-view-cl').textContent = d.credit_line_id;
  document.getElementById('adv-view-currency').innerHTML =
    '<span class="badge badge-' + d.currency.toLowerCase() + '">' + d.currency + '</span>';
  document.getElementById('adv-view-amount').textContent = parseInt(d.amount_original).toLocaleString();
  document.getElementById('adv-view-interest').textContent =
    parseFloat(d.interest_amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('adv-view-status').innerHTML = d.active
    ? '<span class="badge badge-active">Active</span>'
    : '<span class="badge badge-expired">Expired</span>';
  document.getElementById('adv-view-start').textContent = formatDate(d.start_date);
  document.getElementById('adv-view-end').textContent = formatDate(d.end_date);
  document.getElementById('adv-view-cont').textContent = formatDate(d.continuation_date);
  document.getElementById('adv-view-days').textContent = d.days;
  document.getElementById('adv-view-rate').textContent =
    d.rate_pa != null ? parseFloat(d.rate_pa).toFixed(4) + '%' : '—';

  showAdvPanel('view');
  document.getElementById('adv-panel').classList.add('show');
}

async function editAdv(id) {
  const res = await fetch('/advances/' + id);
  if (!res.ok) return;
  const d = await res.json();
  document.getElementById('adv-panel-title').textContent = 'Edit ' + id;
  document.getElementById('adv-edit-id').value = id;
  document.getElementById('adv-bank').value = d.bank;
  document.getElementById('adv-cl').value = d.credit_line_id;
  document.getElementById('adv-currency').value = d.currency;
  document.getElementById('adv-start').value = d.start_date;
  document.getElementById('adv-end').value = d.end_date;
  document.getElementById('adv-cont').value = d.continuation_date;
  setAmountField('adv-amount', d.amount_original, false);
  setAmountField('adv-interest', d.interest_amount, true);
  updateCalcPreview();
  dismissClWarning();
  showAdvPanel('edit');
  document.getElementById('adv-panel').classList.add('show');
}

// "Edit" button inside view mode
document.getElementById('adv-view-edit-btn').addEventListener('click', function() {
  if (currentViewAdvId) editAdv(currentViewAdvId);
});

// Row click → open view mode (skip clicks on action buttons)
document.getElementById('advances-table').addEventListener('click', function(e) {
  if (e.target.closest('.row-actions')) return;
  const row = e.target.closest('tr[data-id]');
  if (row) viewAdv(row.dataset.id);
});

let clWarningAcknowledged = false;

function fmtAmount(n) {
  return Math.round(n).toLocaleString();
}

async function saveAdv(e) {
  e.preventDefault();
  const data = {
    bank: document.getElementById('adv-bank').value,
    credit_line_id: document.getElementById('adv-cl').value,
    currency: document.getElementById('adv-currency').value,
    start_date: document.getElementById('adv-start').value,
    end_date: document.getElementById('adv-end').value,
    continuation_date: document.getElementById('adv-cont').value,
    amount_original: parseNum(document.getElementById('adv-amount').value),
    interest_amount: parseNum(document.getElementById('adv-interest').value),
  };
  const id = document.getElementById('adv-edit-id').value;

  // Check credit line capacity (skip if user already acknowledged)
  if (!clWarningAcknowledged && data.credit_line_id && data.amount_original > 0) {
    const params = new URLSearchParams({
      cl_id: data.credit_line_id,
      amount: data.amount_original,
    });
    if (id) params.set('exclude', id);
    const checkRes = await fetch('/api/check-cl-capacity?' + params);
    if (checkRes.ok) {
      const check = await checkRes.json();
      if (check.exceeded) {
        const warn = document.getElementById('cl-warning');
        document.getElementById('cl-warning-text').textContent =
          'This will exceed credit line ' + data.credit_line_id +
          ' (' + fmtAmount(check.new_drawn) + ' / ' + fmtAmount(check.facility) + ' ' + data.currency + ').' +
          ' Save again to proceed anyway.';
        warn.style.display = 'flex';
        clWarningAcknowledged = true;
        return;
      }
    }
  }

  const url = id ? '/advances/' + id : '/advances';
  const method = id ? 'PUT' : 'POST';
  const res = await fetch(url, {
    method,
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (res.ok) location.reload();
}

async function deleteAdv(id) {
  if (!confirm('Delete advance ' + id + '?')) return;
  const res = await fetch('/advances/' + id, { method: 'DELETE' });
  if (res.ok) location.reload();
}

async function suggestContinuation() {
  const endDate = document.getElementById('adv-end').value;
  if (!endDate) return;
  const res = await fetch('/api/suggest-continuation?end_date=' + endDate);
  if (!res.ok) return;
  const data = await res.json();
  document.getElementById('adv-cont').value = data.continuation_date;
  document.getElementById('cont-hint-text').textContent =
    'Suggested: 3 business days before maturity';
  document.getElementById('cont-hint').style.display = 'flex';
  updateCalcPreview();
}

function updateCalcPreview() {
  const start = document.getElementById('adv-start').value;
  const end = document.getElementById('adv-end').value;
  const amount = parseNum(document.getElementById('adv-amount').value);
  const interest = parseNum(document.getElementById('adv-interest').value);

  if (start && end) {
    const days = Math.round((new Date(end) - new Date(start)) / 86400000);
    document.getElementById('calc-days').textContent = days;
    if (days > 0 && amount > 0) {
      const rate = (interest / amount) * (360 / days) * 100;
      document.getElementById('calc-rate').textContent = rate.toFixed(4) + '%';
    } else {
      document.getElementById('calc-rate').textContent = '—';
    }
  }
}

// Listen for start date changes too
document.getElementById('adv-start').addEventListener('change', updateCalcPreview);

// Auto-open form if ?new=1
if (new URLSearchParams(window.location.search).get('new')) {
  openAdvForm();
  history.replaceState(null, '', '/advances');
}

// ── Column sorting ──
const numericSortKeys = new Set(['amount', 'days', 'rate']);

function sortAdvances(key, th) {
  const table = document.getElementById('advances-table');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr[data-currency]'));
  if (!rows.length) return;

  // Determine column index from the header
  const headers = Array.from(table.querySelectorAll('thead th'));
  const colIdx = headers.indexOf(th);

  // Toggle direction
  const prev = th.getAttribute('data-sort-dir');
  const dir = prev === 'asc' ? 'desc' : 'asc';

  // Clear all sort indicators and directions
  headers.forEach(h => {
    h.removeAttribute('data-sort-dir');
    const ind = h.querySelector('.sort-indicator');
    if (ind) ind.textContent = '';
  });

  th.setAttribute('data-sort-dir', dir);
  th.querySelector('.sort-indicator').textContent = dir === 'asc' ? ' ▲' : ' ▼';

  const isNumeric = numericSortKeys.has(key);

  rows.sort((a, b) => {
    const cellA = a.children[colIdx];
    const cellB = b.children[colIdx];
    let valA = cellA.getAttribute('data-sort-value') || cellA.textContent.trim();
    let valB = cellB.getAttribute('data-sort-value') || cellB.textContent.trim();

    if (isNumeric) {
      valA = parseFloat(valA) || 0;
      valB = parseFloat(valB) || 0;
      return dir === 'asc' ? valA - valB : valB - valA;
    }
    return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });

  rows.forEach(row => tbody.appendChild(row));
}

// Bind click handlers on sortable headers
document.querySelectorAll('#advances-table thead th[data-sort]').forEach(th => {
  th.addEventListener('click', () => sortAdvances(th.dataset.sort, th));
});

function filterAdvances(filter, pill) {
  document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
  pill.classList.add('active');
  document.querySelectorAll('#advances-table tbody tr').forEach(row => {
    if (filter === 'all') {
      row.style.display = '';
    } else if (filter === 'active') {
      row.style.display = row.dataset.active === 'true' ? '' : 'none';
    } else {
      row.style.display = row.dataset.currency === filter ? '' : 'none';
    }
  });
}
</script>
{% endblock %}
