{% extends "base.html" %}
{% set active_page = "advances" %}

{% block title %}Fixed Advances — TenorDash{% endblock %}

{% block content %}
<div class="topbar">
  <h2>Fixed Advances</h2>
  <div class="topbar-actions">
    <button class="btn-primary" onclick="openAdvForm()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="2" x2="7" y2="12"/><line x1="2" y1="7" x2="12" y2="7"/></svg>
      New Advance
    </button>
  </div>
</div>

<div class="section">
  <div class="section-header">
    <h3>All Advances ({{ advances|length }})</h3>
    <div class="filter-pills">
      <span class="pill active" data-filter="all" onclick="filterAdvances('all', this)">All</span>
      <span class="pill" data-filter="active" onclick="filterAdvances('active', this)">Active</span>
      {% for curr in currencies %}
      <span class="pill" data-filter="{{ curr.code }}" onclick="filterAdvances('{{ curr.code }}', this)">{{ curr.code }}</span>
      {% endfor %}
    </div>
  </div>
  <table class="data-table" id="advances-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Bank</th>
        <th>Credit Line</th>
        <th>Currency</th>
        <th style="text-align:right">Amount</th>
        <th>Start</th>
        <th>End</th>
        <th>Continuation</th>
        <th style="text-align:right">Days</th>
        <th style="text-align:right">Rate p.a.</th>
        <th>Status</th>
        <th style="text-align:right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for adv in advances %}
      <tr data-currency="{{ adv.currency }}" data-active="{{ 'true' if adv.active else 'false' }}">
        <td class="mono text-muted">{{ adv.id }}</td>
        <td>{{ adv.bank }}</td>
        <td class="text-muted">{{ adv.credit_line_id }}</td>
        <td><span class="badge badge-{{ adv.currency|lower }}">{{ adv.currency }}</span></td>
        <td class="mono text-right text-{{ adv.currency|lower }}">{{ adv.amount_original|amount }}</td>
        <td>{{ adv.start_date|date_display }}</td>
        <td>{{ adv.end_date|date_display }}</td>
        <td>{{ adv.continuation_date|date_display }}</td>
        <td class="mono text-right">{{ adv.days }}</td>
        <td class="mono text-right">{{ adv.rate_pa|rate }}</td>
        <td><span class="badge {{ 'badge-active' if adv.active else 'badge-expired' }}">{{ 'Active' if adv.active else 'Expired' }}</span></td>
        <td>
          <div class="row-actions">
            <button onclick="editAdv('{{ adv.id }}')" title="Edit">&#9998;</button>
            <button class="delete" onclick="deleteAdv('{{ adv.id }}')" title="Delete">&times;</button>
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="12">
          <div class="empty-state">
            <p>No fixed advances yet.</p>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Slide-out Panel -->
<div class="panel-overlay" id="adv-panel">
  <div class="slide-panel">
    <h3>
      <span id="adv-form-title">New Fixed Advance</span>
      <button class="panel-close" onclick="closeAdvForm()">&times;</button>
    </h3>
    <form id="adv-form" onsubmit="saveAdv(event)">
      <input type="hidden" id="adv-edit-id" value="" />

      <div class="form-row">
        <div class="form-group">
          <label>Bank</label>
          <select id="adv-bank" required>
            <option value="">Select bank...</option>
            {% for bank in banks %}
            <option value="{{ bank.bank_name }}">{{ bank.bank_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Credit Line</label>
          <select id="adv-cl" required onchange="dismissClWarning()">
            <option value="">Select...</option>
            {% for cl in lines %}
            <option value="{{ cl.id }}">{{ cl.id }} — {{ cl.description or cl.bank_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Currency</label>
        <div class="select-with-add">
          <select id="adv-currency" required>
            {% for curr in currencies %}
            <option value="{{ curr.code }}">{{ curr.code }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn-add-currency" onclick="openCurrencyModal()" title="Add currency">+</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" id="adv-start" required />
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input type="date" id="adv-end" required onchange="suggestContinuation()" />
        </div>
      </div>

      <div class="form-group">
        <label>Continuation Date</label>
        <input type="date" id="adv-cont" required />
        <div class="form-hint" id="cont-hint" style="display:none">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="#0d7c5f"><circle cx="5" cy="5" r="4"/></svg>
          <span id="cont-hint-text"></span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Amount</label>
          <input type="text" id="adv-amount" required placeholder="e.g. 50,000,000" oninput="formatAmountField(this); updateCalcPreview(); dismissClWarning()" inputmode="numeric" />
        </div>
        <div class="form-group">
          <label>Interest Amount</label>
          <input type="text" id="adv-interest" required placeholder="e.g. 196,527.78" oninput="formatAmountField(this, true); updateCalcPreview()" inputmode="decimal" />
        </div>
      </div>

      <div class="calc-preview" id="calc-preview">
        <div>
          <div class="calc-label">Days</div>
          <div class="calc-value" id="calc-days">—</div>
        </div>
        <div>
          <div class="calc-label">Rate p.a. (calc)</div>
          <div class="calc-value" id="calc-rate">—</div>
        </div>
      </div>

      <div class="cl-warning" id="cl-warning" style="display:none">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="#A62152"><path d="M7 0a7 7 0 100 14A7 7 0 007 0zm0 3a1 1 0 011 1v3a1 1 0 01-2 0V4a1 1 0 011-1zm0 7a1 1 0 110 2 1 1 0 010-2z"/></svg>
        <span id="cl-warning-text"></span>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeAdvForm()">Cancel</button>
        <button type="submit" class="btn-primary">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2 7 5.5 10.5 12 4"/></svg>
          Save Advance
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Detect locale separators: e.g. "1,234.5" vs "1.234,5"
const _decSep = (1.1).toLocaleString().charAt(1);
const _thouSep = (1000).toLocaleString().length > 4 ? (1000).toLocaleString().charAt(1) : '';
const _stripGroupRe = _thouSep ? new RegExp('\\' + _thouSep, 'g') : null;

function parseNum(str) {
  let s = (str || '');
  if (_stripGroupRe) s = s.replace(_stripGroupRe, '');
  if (_decSep !== '.') s = s.replace(_decSep, '.');
  return parseFloat(s) || 0;
}

function formatAmountField(el, allowDecimals) {
  const pos = el.selectionStart;
  const oldLen = el.value.length;
  // Strip everything except digits and locale decimal separator
  let raw = el.value.replace(new RegExp('[^0-9' + (_decSep === '.' ? '\\.' : '\\' + _decSep) + ']', 'g'), '');
  // Normalise to dot for splitting
  if (_decSep !== '.') raw = raw.replace(_decSep, '.');
  if (!allowDecimals) raw = raw.replace(/\./g, '');
  if (!raw) { el.value = ''; return; }
  const parts = raw.split('.');
  parts[0] = parseInt(parts[0], 10).toLocaleString();
  el.value = allowDecimals && parts.length > 1 ? parts[0] + _decSep + parts[1].slice(0, 2) : parts[0];
  const newLen = el.value.length;
  const newPos = Math.max(0, pos + (newLen - oldLen));
  el.setSelectionRange(newPos, newPos);
}

function setAmountField(id, value, allowDecimals) {
  const el = document.getElementById(id);
  if (allowDecimals) {
    el.value = parseFloat(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  } else {
    el.value = parseInt(value).toLocaleString();
  }
}

function dismissClWarning() {
  clWarningAcknowledged = false;
  document.getElementById('cl-warning').style.display = 'none';
}

function openAdvForm() {
  document.getElementById('adv-form-title').textContent = 'New Fixed Advance';
  document.getElementById('adv-form').reset();
  document.getElementById('adv-edit-id').value = '';
  document.getElementById('cont-hint').style.display = 'none';
  document.getElementById('calc-days').textContent = '—';
  document.getElementById('calc-rate').textContent = '—';
  dismissClWarning();
  document.getElementById('adv-panel').classList.add('show');
}

function closeAdvForm() {
  document.getElementById('adv-panel').classList.remove('show');
}

async function editAdv(id) {
  const res = await fetch('/advances/' + id);
  if (!res.ok) return;
  const d = await res.json();
  document.getElementById('adv-form-title').textContent = 'Edit ' + id;
  document.getElementById('adv-edit-id').value = id;
  document.getElementById('adv-bank').value = d.bank;
  document.getElementById('adv-cl').value = d.credit_line_id;
  document.getElementById('adv-currency').value = d.currency;
  document.getElementById('adv-start').value = d.start_date;
  document.getElementById('adv-end').value = d.end_date;
  document.getElementById('adv-cont').value = d.continuation_date;
  setAmountField('adv-amount', d.amount_original, false);
  setAmountField('adv-interest', d.interest_amount, true);
  updateCalcPreview();
  dismissClWarning();
  document.getElementById('adv-panel').classList.add('show');
}

let clWarningAcknowledged = false;

function fmtAmount(n) {
  return Math.round(n).toLocaleString();
}

async function saveAdv(e) {
  e.preventDefault();
  const data = {
    bank: document.getElementById('adv-bank').value,
    credit_line_id: document.getElementById('adv-cl').value,
    currency: document.getElementById('adv-currency').value,
    start_date: document.getElementById('adv-start').value,
    end_date: document.getElementById('adv-end').value,
    continuation_date: document.getElementById('adv-cont').value,
    amount_original: parseNum(document.getElementById('adv-amount').value),
    interest_amount: parseNum(document.getElementById('adv-interest').value),
  };
  const id = document.getElementById('adv-edit-id').value;

  // Check credit line capacity (skip if user already acknowledged)
  if (!clWarningAcknowledged && data.credit_line_id && data.amount_original > 0) {
    const params = new URLSearchParams({
      cl_id: data.credit_line_id,
      amount: data.amount_original,
    });
    if (id) params.set('exclude', id);
    const checkRes = await fetch('/api/check-cl-capacity?' + params);
    if (checkRes.ok) {
      const check = await checkRes.json();
      if (check.exceeded) {
        const warn = document.getElementById('cl-warning');
        document.getElementById('cl-warning-text').textContent =
          'This will exceed credit line ' + data.credit_line_id +
          ' (' + fmtAmount(check.new_drawn) + ' / ' + fmtAmount(check.facility) + ' ' + data.currency + ').' +
          ' Save again to proceed anyway.';
        warn.style.display = 'flex';
        clWarningAcknowledged = true;
        return;
      }
    }
  }

  const url = id ? '/advances/' + id : '/advances';
  const method = id ? 'PUT' : 'POST';
  const res = await fetch(url, {
    method,
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (res.ok) location.reload();
}

async function deleteAdv(id) {
  if (!confirm('Delete advance ' + id + '?')) return;
  const res = await fetch('/advances/' + id, { method: 'DELETE' });
  if (res.ok) location.reload();
}

async function suggestContinuation() {
  const endDate = document.getElementById('adv-end').value;
  if (!endDate) return;
  const res = await fetch('/api/suggest-continuation?end_date=' + endDate);
  if (!res.ok) return;
  const data = await res.json();
  document.getElementById('adv-cont').value = data.continuation_date;
  document.getElementById('cont-hint-text').textContent =
    'Suggested: 3 business days before maturity';
  document.getElementById('cont-hint').style.display = 'flex';
  updateCalcPreview();
}

function updateCalcPreview() {
  const start = document.getElementById('adv-start').value;
  const end = document.getElementById('adv-end').value;
  const amount = parseNum(document.getElementById('adv-amount').value);
  const interest = parseNum(document.getElementById('adv-interest').value);

  if (start && end) {
    const days = Math.round((new Date(end) - new Date(start)) / 86400000);
    document.getElementById('calc-days').textContent = days;
    if (days > 0 && amount > 0) {
      const rate = (interest / amount) * (360 / days) * 100;
      document.getElementById('calc-rate').textContent = rate.toFixed(4) + '%';
    } else {
      document.getElementById('calc-rate').textContent = '—';
    }
  }
}

// Listen for start date changes too
document.getElementById('adv-start').addEventListener('change', updateCalcPreview);

// Auto-open form if ?new=1
if (new URLSearchParams(window.location.search).get('new')) {
  openAdvForm();
  history.replaceState(null, '', '/advances');
}

function filterAdvances(filter, pill) {
  document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
  pill.classList.add('active');
  document.querySelectorAll('#advances-table tbody tr').forEach(row => {
    if (filter === 'all') {
      row.style.display = '';
    } else if (filter === 'active') {
      row.style.display = row.dataset.active === 'true' ? '' : 'none';
    } else {
      row.style.display = row.dataset.currency === filter ? '' : 'none';
    }
  });
}
</script>
{% endblock %}
