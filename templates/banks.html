{% extends "base.html" %}
{% set active_page = "banks" %}

{% block title %}Banks — TenorDash{% endblock %}

{% block content %}
<div class="topbar">
  <h2>Banks</h2>
  <div class="topbar-actions">
    <button class="btn-secondary" onclick="window.print()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3.5 5V1.5h7V5"/><rect x="1.5" y="5" width="11" height="5.5" rx="1"/><path d="M3.5 8.5h7v4h-7z"/></svg>
      Print
    </button>
    <button class="btn-primary" onclick="openBankForm()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="2" x2="7" y2="12"/><line x1="2" y1="7" x2="12" y2="7"/></svg>
      Add Bank
    </button>
  </div>
</div>

<div class="section">
  <table class="data-table" id="banks-table">
    <thead>
      <tr>
        <th>Bank Key</th>
        <th>Bank Name</th>
        <th style="text-align:right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for bank in banks %}
      <tr data-key="{{ bank.bank_key }}" data-id="{{ bank.bank_key }}">
        <td class="mono text-muted">{{ bank.bank_key }}</td>
        <td>{{ bank.bank_name }}</td>
        <td>
          <div class="row-actions">
            <button onclick="editBank('{{ bank.bank_key }}', '{{ bank.bank_name }}')" title="Edit">&#9998;</button>
            <button class="delete" onclick="deleteBank('{{ bank.bank_key }}')" title="Delete">&times;</button>
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="3">
          <div class="empty-state">
            <p>No banks yet. Add one to get started.</p>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- View Modal -->
<div class="modal-overlay" id="bank-view-modal">
  <div class="modal-box" style="width: 400px;">
    <h3>
      <span id="bank-view-title"></span>
      <button class="panel-close" onclick="closeBankView()">&times;</button>
    </h3>
    <div class="panel-view">
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">Bank Key</div>
          <div class="detail-value mono" id="bank-view-key"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Bank Name</div>
          <div class="detail-value" id="bank-view-name"></div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeBankView()">Close</button>
        <button type="button" class="btn-primary" id="bank-view-edit-btn">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 1.5l2 2L4 12H2v-2z"/></svg>
          Edit
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="bank-panel">
  <div class="modal-box" style="width: 400px;">
    <h3>
      <span id="bank-form-title">Add Bank</span>
      <button class="panel-close" onclick="closeBankForm()">&times;</button>
    </h3>
    <form id="bank-form" onsubmit="saveBank(event)">
      <div class="form-group">
        <label>Bank Key</label>
        <input type="text" id="bank-key" required placeholder="e.g. B001" />
      </div>
      <div class="form-group">
        <label>Bank Name</label>
        <input type="text" id="bank-name" required placeholder="e.g. UBS" />
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeBankForm()">Cancel</button>
        <button type="submit" class="btn-primary">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2 7 5.5 10.5 12 4"/></svg>
          Save
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentViewBankKey = null;

function openBankForm(key, name) {
  document.getElementById('bank-form-title').textContent = key ? 'Edit Bank' : 'Add Bank';
  document.getElementById('bank-key').value = key || '';
  document.getElementById('bank-name').value = name || '';
  document.getElementById('bank-key').readOnly = !!key;
  document.getElementById('bank-panel').classList.add('show');
  document.getElementById(key ? 'bank-name' : 'bank-key').focus();
}

function closeBankForm() {
  document.getElementById('bank-panel').classList.remove('show');
}

function closeBankView() {
  document.getElementById('bank-view-modal').classList.remove('show');
}

function viewBank(key, name) {
  currentViewBankKey = key;
  document.getElementById('bank-view-title').textContent = name;
  document.getElementById('bank-view-key').textContent = key;
  document.getElementById('bank-view-name').textContent = name;
  document.getElementById('bank-view-modal').classList.add('show');
}

function editBank(key, name) {
  openBankForm(key, name);
}

// "Edit" button inside view mode — close view, open edit
document.getElementById('bank-view-edit-btn').addEventListener('click', function() {
  if (currentViewBankKey) {
    const name = document.getElementById('bank-view-name').textContent;
    closeBankView();
    editBank(currentViewBankKey, name);
  }
});

// Row click → open view mode (skip clicks on action buttons)
document.getElementById('banks-table').addEventListener('click', function(e) {
  if (e.target.closest('.row-actions')) return;
  const row = e.target.closest('tr[data-key]');
  if (row) {
    const key = row.dataset.key;
    const name = row.children[1].textContent;
    viewBank(key, name);
  }
});

async function saveBank(e) {
  e.preventDefault();
  const data = {
    bank_key: document.getElementById('bank-key').value.trim(),
    bank_name: document.getElementById('bank-name').value.trim()
  };
  const res = await fetch('/banks', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (res.ok) location.reload();
}

async function deleteBank(key) {
  if (!confirm('Delete bank ' + key + '?')) return;
  const res = await fetch('/banks/' + key, { method: 'DELETE' });
  if (res.ok) location.reload();
}
</script>
{% endblock %}
