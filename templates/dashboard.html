{% extends "base.html" %}
{% set active_page = "dashboard" %}
{% set alert_count = alerts|length %}

{% block title %}Dashboard — TenorDash{% endblock %}

{% block content %}
<div class="topbar">
  <h2>Dashboard</h2>
  <div class="topbar-actions">
    <button class="btn-secondary" onclick="window.print()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3.5 5V1.5h7V5"/><rect x="1.5" y="5" width="11" height="5.5" rx="1"/><path d="M3.5 8.5h7v4h-7z"/></svg>
      Print
    </button>
    <a href="/credit-lines?new=1" class="btn-secondary">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="2" x2="7" y2="12"/><line x1="2" y1="7" x2="12" y2="7"/></svg>
      New Credit Line
    </a>
    <a href="/advances?new=1" class="btn-primary">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="2" x2="7" y2="12"/><line x1="2" y1="7" x2="12" y2="7"/></svg>
      New Advance
    </a>
  </div>
</div>

<div class="dashboard-grid">
  <!-- Left column: Currency cards + Active Instruments -->
  <div class="dashboard-main">
    <div class="cards">
      {% for curr in currencies %}
      {% if totals.get(curr.code) %}
      <div class="card">
        <div class="card-label">Active {{ curr.code }}</div>
        <div class="card-value {{ curr.code|lower }}">{{ totals[curr.code].total|amount_short }}</div>
        <div class="card-sub">{{ totals[curr.code].count }} instrument{{ 's' if totals[curr.code].count != 1 }}</div>
      </div>
      {% endif %}
      {% endfor %}
    </div>

    <div class="section">
      <div class="section-header">
        <h3>Active Instruments ({{ active|length }})</h3>
        <div class="filter-pills">
          <span class="pill active" onclick="filterDash('all', this)">All</span>
          {% for curr in currencies %}
          <span class="pill" onclick="filterDash('{{ curr.code }}', this)">{{ curr.code }}</span>
          {% endfor %}
        </div>
      </div>
      <table class="data-table" id="dash-table">
        <thead>
          <tr>
            <th data-sort="id">ID <span class="sort-indicator"></span></th>
            <th data-sort="bank">Bank <span class="sort-indicator"></span></th>
            <th data-sort="credit_line">Credit Line <span class="sort-indicator"></span></th>
            <th data-sort="currency">Currency <span class="sort-indicator"></span></th>
            <th data-sort="amount" style="text-align:right">Amount <span class="sort-indicator"></span></th>
            <th data-sort="start">Start <span class="sort-indicator"></span></th>
            <th data-sort="end">End <span class="sort-indicator"></span></th>
            <th data-sort="continuation">Continuation <span class="sort-indicator"></span></th>
            <th data-sort="rate" style="text-align:right">Rate p.a. <span class="sort-indicator"></span></th>
          </tr>
        </thead>
        <tbody>
          {% set alert_ids = alerts|map(attribute='id')|list %}
          {% for adv in active %}
          {% set is_alert = adv.id in alert_ids %}
          <tr class="{{ 'alert-row' if is_alert }}" data-id="{{ adv.id }}" data-currency="{{ adv.currency }}">
            <td class="mono text-muted">{{ adv.id }}</td>
            <td>{{ adv.bank }}</td>
            <td class="text-muted">{{ adv.credit_line_id }}</td>
            <td><span class="badge badge-{{ adv.currency|lower }}">{{ adv.currency }}</span></td>
            <td class="mono text-right text-{{ adv.currency|lower }}" data-sort-value="{{ adv.amount_original }}">{{ adv.amount_original|amount }}</td>
            <td data-sort-value="{{ adv.start_date }}">{{ adv.start_date|date_display }}</td>
            <td data-sort-value="{{ adv.end_date }}">{{ adv.end_date|date_display }}</td>
            <td class="{{ 'text-alert' if is_alert }}" data-sort-value="{{ adv.continuation_date }}">{{ adv.continuation_date|date_display }}</td>
            <td class="mono text-right" data-sort-value="{{ adv.rate_pa }}">{{ adv.rate_pa|rate }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <p>No active instruments.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Right column: sidebar -->
  <div class="dashboard-sidebar">
    <div class="card {{ 'alert-card' if alerts }}">
      <div class="card-label">Continuations Due</div>
      <div class="card-value">{{ alerts|length }}</div>
      <div class="card-sub">within next 7 days</div>
    </div>

    {% if alerts or upcoming %}
    <div class="continuations-widget">
      <div class="alert-title">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="#A62152"><path d="M7 0a7 7 0 100 14A7 7 0 007 0zm0 3a1 1 0 011 1v3a1 1 0 01-2 0V4a1 1 0 011-1zm0 7a1 1 0 110 2 1 1 0 010-2z"/></svg>
        Upcoming Continuations
      </div>
      <div class="continuation-view-switch">
        <button class="pill active" type="button" data-view="list" onclick="switchContinuationView('list', this)">List</button>
        <button class="pill" type="button" data-view="calendar" onclick="switchContinuationView('calendar', this)">Calendar</button>
      </div>

      <!-- Timeline: Date-left list card -->
      <div class="continuation-view is-active" id="continuation-view-list">
        {% for a in upcoming %}
        <div class="continuation-row">
          <div class="continuation-date-chip">
            <div class="day-mon">
              <div class="day">{{ a.cont_day }}</div>
              <div class="mon">{{ a.cont_mon }}</div>
            </div>
            <div class="dow">{{ a.cont_weekday }}</div>
          </div>
          <div class="continuation-main">
            <div class="id-line"><strong>{{ a.id }}</strong> &middot; {{ a.bank }}</div>
            <div class="meta">{{ a.currency }} {{ a.amount_original|amount }}</div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Calendar + compact list -->
      <div class="continuation-view" id="continuation-view-calendar">
        {% if continuation_calendar is defined %}
        <div class="mini-calendar">
          <div class="mini-cal-header">
            <button class="cal-nav-btn" type="button" onclick="navigateCalendar(-1)" aria-label="Previous month">&lsaquo;</button>
            <strong id="cal-month-label"
                    data-year="{{ continuation_calendar.year }}"
                    data-month="{{ continuation_calendar.month }}">{{ continuation_calendar.month_label }}</strong>
            <button class="cal-nav-btn" type="button" onclick="navigateCalendar(1)" aria-label="Next month">&rsaquo;</button>
          </div>
          <div class="mini-cal-grid mini-cal-weekdays">
            <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
          </div>
          <div class="mini-cal-grid mini-cal-days" id="cal-days-grid">
            {% for cell in continuation_calendar.cells %}
            <div class="mini-cal-day {{ 'marked' if cell.marked }} {{ 'today' if cell.today }}"
              {%- if cell.marked and tooltip_map.get(cell.date) %} data-tooltip="{{ tooltip_map[cell.date] }}"{% endif %}>
              {{ cell.day }}
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="calendar-legend">Accent markers = continuation dates</div>
        {% endif %}
        <div class="calendar-list" id="cal-list" data-cont-limit="{{ cont_limit or 0 }}">
          {% for a in upcoming %}
          <div class="calendar-list-item">
            <strong>{{ a.cont_day }} {{ a.cont_mon }}</strong> · {{ a.id }} · {{ a.bank }} · {{ a.currency }} {{ a.amount_original|amount }}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card">
      <div class="card-label">CL Utilization ({{ BASE_CURRENCY }} eq.)</div>
      {% if utilization and fx_rates %}
        {% set ns = namespace(drawn=0, facility=0) %}
        {% for u in utilization %}
          {% set rate = fx_rates.get(u.currency, 1.0) %}
          {% set ns.drawn = ns.drawn + u.drawn_amount * rate %}
          {% set ns.facility = ns.facility + u.facility_amount * rate %}
        {% endfor %}
        <div class="card-value">{{ ((ns.drawn / ns.facility * 100) if ns.facility > 0 else 0)|round|int }}%</div>
        <div class="card-sub">{{ ns.drawn|int|amount_short }} / {{ ns.facility|int|amount_short }} {{ BASE_CURRENCY }}</div>
      {% else %}
        <div class="card-value">—</div>
        <div class="card-sub">No credit lines</div>
      {% endif %}
    </div>

    {% if utilization %}
    <div class="section">
      <div class="section-header">
        <h3>Credit Line Utilization</h3>
      </div>
      <div style="padding: 16px 20px;">
        {% for u in utilization %}
        {% set pct = (u.drawn_amount / u.facility_amount * 100) if u.facility_amount > 0 else 0 %}
        <div class="util-item">
          <div class="util-header">
            <strong>{{ u.id }} {{ u.description or '' }}</strong>
            <span>{{ u.drawn_amount|amount_short }} / {{ u.facility_amount|amount_short }} {{ u.currency }}</span>
          </div>
          <div class="util-bar">
            <div class="util-bar-fill {{ 'over' if pct > 100 else 'warn' if pct > 80 else u.currency|lower }}"
                 style="width: {{ [pct, 100]|min }}%"></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</div>
<!-- View-only Modal -->
<div class="modal-overlay" id="dash-panel">
  <div class="modal-box" style="width: 480px;">
    <h3>
      <span id="dash-panel-title"></span>
      <button class="panel-close" onclick="closeDashPanel()">&times;</button>
    </h3>
    <div class="panel-view">
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">Bank</div>
          <div class="detail-value" id="dash-view-bank"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Credit Line</div>
          <div class="detail-value" id="dash-view-cl"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Currency</div>
          <div class="detail-value" id="dash-view-currency"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Amount</div>
          <div class="detail-value mono" id="dash-view-amount"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Interest Amount</div>
          <div class="detail-value mono" id="dash-view-interest"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Status</div>
          <div class="detail-value" id="dash-view-status"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Start Date</div>
          <div class="detail-value" id="dash-view-start"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">End Date</div>
          <div class="detail-value" id="dash-view-end"></div>
        </div>
        <div class="detail-item full-width">
          <div class="detail-label">Continuation Date</div>
          <div class="detail-value" id="dash-view-cont"></div>
        </div>
      </div>
      <div class="detail-calc">
        <div>
          <div class="calc-label">Days</div>
          <div class="calc-value" id="dash-view-days"></div>
        </div>
        <div>
          <div class="calc-label">Rate p.a.</div>
          <div class="calc-value" id="dash-view-rate"></div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeDashPanel()">Close</button>
        <a href="#" class="btn-primary" id="dash-view-edit-link">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 1.5l2 2L4 12H2v-2z"/></svg>
          Edit
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ── Column sorting ──
const numericSortKeys = new Set(['amount', 'rate']);

function sortDashTable(key, th) {
  const table = document.getElementById('dash-table');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr[data-currency]'));
  if (!rows.length) return;

  const headers = Array.from(table.querySelectorAll('thead th'));
  const colIdx = headers.indexOf(th);

  const prev = th.getAttribute('data-sort-dir');
  const dir = prev === 'asc' ? 'desc' : 'asc';

  headers.forEach(h => {
    h.removeAttribute('data-sort-dir');
    const ind = h.querySelector('.sort-indicator');
    if (ind) ind.textContent = '';
  });

  th.setAttribute('data-sort-dir', dir);
  th.querySelector('.sort-indicator').textContent = dir === 'asc' ? ' ▲' : ' ▼';

  const isNumeric = numericSortKeys.has(key);

  rows.sort((a, b) => {
    const cellA = a.children[colIdx];
    const cellB = b.children[colIdx];
    let valA = cellA.getAttribute('data-sort-value') || cellA.textContent.trim();
    let valB = cellB.getAttribute('data-sort-value') || cellB.textContent.trim();

    if (isNumeric) {
      valA = parseFloat(valA) || 0;
      valB = parseFloat(valB) || 0;
      return dir === 'asc' ? valA - valB : valB - valA;
    }
    return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });

  rows.forEach(row => tbody.appendChild(row));
}

document.querySelectorAll('#dash-table thead th[data-sort]').forEach(th => {
  th.addEventListener('click', () => sortDashTable(th.dataset.sort, th));
});

function filterDash(filter, pill) {
  document.querySelectorAll('.section-header .filter-pills .pill').forEach(p => p.classList.remove('active'));
  pill.classList.add('active');
  document.querySelectorAll('#dash-table tbody tr').forEach(row => {
    if (filter === 'all') {
      row.style.display = '';
    } else {
      row.style.display = row.dataset.currency === filter ? '' : 'none';
    }
  });
}

// ── View panel on row click ──

function closeDashPanel() {
  document.getElementById('dash-panel').classList.remove('show');
}

async function viewDashAdv(id) {
  const res = await fetch('/advances/' + id);
  if (!res.ok) return;
  const d = await res.json();

  document.getElementById('dash-panel-title').textContent = id;
  document.getElementById('dash-view-bank').textContent = d.bank;
  document.getElementById('dash-view-cl').textContent = d.credit_line_id;
  document.getElementById('dash-view-currency').innerHTML =
    '<span class="badge badge-' + d.currency.toLowerCase() + '">' + d.currency + '</span>';
  document.getElementById('dash-view-amount').textContent = parseInt(d.amount_original).toLocaleString();
  document.getElementById('dash-view-interest').textContent =
    parseFloat(d.interest_amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('dash-view-status').innerHTML = d.active
    ? '<span class="badge badge-active">Active</span>'
    : '<span class="badge badge-expired">Expired</span>';
  document.getElementById('dash-view-start').textContent = formatDate(d.start_date);
  document.getElementById('dash-view-end').textContent = formatDate(d.end_date);
  document.getElementById('dash-view-cont').textContent = formatDate(d.continuation_date);
  document.getElementById('dash-view-days').textContent = d.days;
  document.getElementById('dash-view-rate').textContent =
    d.rate_pa != null ? parseFloat(d.rate_pa).toFixed(4) + '%' : '\u2014';

  // Edit link navigates to advances page with edit panel open
  document.getElementById('dash-view-edit-link').href = '/advances#edit-' + id;

  document.getElementById('dash-panel').classList.add('show');
}

document.getElementById('dash-table').addEventListener('click', function(e) {
  const row = e.target.closest('tr[data-id]');
  if (row) viewDashAdv(row.dataset.id);
});

function switchContinuationView(view, btn) {
  document.querySelectorAll('.continuation-view-switch .pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.continuation-view').forEach(v => v.classList.remove('is-active'));
  const target = document.getElementById('continuation-view-' + view);
  if (target) target.classList.add('is-active');
}

// ── Calendar month navigation ──

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function navigateCalendar(delta) {
  const label = document.getElementById('cal-month-label');
  if (!label) return;

  let year = parseInt(label.dataset.year, 10);
  let month = parseInt(label.dataset.month, 10) + delta;

  if (month < 1) { month = 12; year--; }
  if (month > 12) { month = 1; year++; }

  const res = await fetch('/api/continuation-calendar?year=' + year + '&month=' + month);
  if (!res.ok) return;
  const data = await res.json();
  const cal = data.calendar;

  // Update label
  label.textContent = cal.month_label;
  label.dataset.year = cal.year;
  label.dataset.month = cal.month;

  // Build tooltip map from items
  const tooltipMap = {};
  data.items.forEach(function(it) {
    if (!tooltipMap[it.date]) tooltipMap[it.date] = [];
    tooltipMap[it.date].push(esc(it.id) + ' \u00b7 ' + esc(it.bank) + ' \u00b7 ' + esc(it.currency) + ' ' + esc(it.amount));
  });

  // Rebuild day grid
  const grid = document.getElementById('cal-days-grid');
  grid.innerHTML = cal.cells.map(function(c) {
    const cls = ['mini-cal-day'];
    if (c.marked) cls.push('marked');
    if (c.today) cls.push('today');
    const tip = c.marked && tooltipMap[c.date] ? ' data-tooltip="' + tooltipMap[c.date].join('\n').replace(/"/g, '&quot;') + '"' : '';
    return '<div class="' + cls.join(' ') + '"' + tip + '>' + (c.day || '') + '</div>';
  }).join('');

  // Rebuild list (respect display limit)
  const list = document.getElementById('cal-list');
  const limitAttr = parseInt(list.dataset.contLimit, 10);
  const displayItems = limitAttr > 0 ? data.items.slice(0, limitAttr) : data.items;
  if (displayItems.length === 0) {
    list.innerHTML = '<div class="calendar-list-item" style="color:var(--text-muted)">No continuations this month</div>';
  } else {
    list.innerHTML = displayItems.map(function(it) {
      return '<div class="calendar-list-item"><strong>' + esc(it.day + ' ' + it.mon) + '</strong> · ' + esc(it.id) + ' · ' + esc(it.bank) + ' · ' + esc(it.currency) + ' ' + esc(it.amount) + '</div>';
    }).join('');
  }
}
</script>
{% endblock %}
