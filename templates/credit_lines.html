{% extends "base.html" %}
{% set active_page = "credit_lines" %}

{% block title %}Credit Lines — TenorDash{% endblock %}

{% block content %}
<div class="topbar">
  <h2>Credit Lines</h2>
  <div class="topbar-actions">
    <button class="btn-secondary" onclick="window.print()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3.5 5V1.5h7V5"/><rect x="1.5" y="5" width="11" height="5.5" rx="1"/><path d="M3.5 8.5h7v4h-7z"/></svg>
      Print
    </button>
    <button class="btn-primary" onclick="openCLForm()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="2" x2="7" y2="12"/><line x1="2" y1="7" x2="12" y2="7"/></svg>
      New Credit Line
    </button>
  </div>
</div>

<div class="section">
  <div class="section-header">
    <h3>Credit Lines ({{ lines|selectattr('archived', 'equalto', 0)|list|length }})</h3>
    <div class="filter-pills">
      <span class="pill active" data-filter="active" onclick="filterCLs('active', this)">Active</span>
      <span class="pill" data-filter="archived" onclick="filterCLs('archived', this)">Archived</span>
      <span class="pill" data-filter="all" onclick="filterCLs('all', this)">All</span>
    </div>
  </div>
  <table class="data-table" id="cl-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Bank</th>
        <th>Description</th>
        <th>Currency</th>
        <th style="text-align:right">Amount</th>
        <th>Committed</th>
        <th>Start</th>
        <th>End</th>
        <th>Status</th>
        <th style="text-align:right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cl in lines %}
      <tr data-id="{{ cl.id }}" data-archived="{{ 'true' if cl.archived else 'false' }}">
        <td class="mono text-muted">{{ cl.id }}</td>
        <td>{{ cl.bank_name or cl.bank_key }}</td>
        <td>{{ cl.description or '' }}</td>
        <td><span class="badge badge-{{ cl.currency|lower }}">{{ cl.currency }}</span></td>
        <td class="mono text-right text-{{ cl.currency|lower }}">{{ cl.amount|amount }}</td>
        <td>{{ cl.committed }}</td>
        <td>{{ cl.start_date|date_display }}</td>
        <td>{{ cl.end_date|date_display if cl.end_date else '—' }}</td>
        <td>
          {% if cl.archived %}
          <span class="badge badge-archived">Archived</span>
          {% else %}
          <span class="badge badge-active">Active</span>
          {% endif %}
        </td>
        <td>
          <div class="row-actions">
            {% if cl.archived %}
            <button onclick="restoreCL('{{ cl.id }}')" title="Restore">&#8634;</button>
            {% else %}
            <button onclick="editCL('{{ cl.id }}')" title="Edit">&#9998;</button>
            <button class="delete" onclick="archiveCL('{{ cl.id }}')" title="Archive">&#128451;</button>
            {% endif %}
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="10">
          <div class="empty-state">
            <p>No credit lines yet.</p>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- View Modal -->
<div class="modal-overlay" id="cl-view-modal">
  <div class="modal-box" style="width: 480px;">
    <h3>
      <span id="cl-view-title"></span>
      <button class="panel-close" onclick="closeCLView()">&times;</button>
    </h3>
    <div class="panel-view">
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">Bank</div>
          <div class="detail-value" id="cl-view-bank"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Description</div>
          <div class="detail-value" id="cl-view-description"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Currency</div>
          <div class="detail-value" id="cl-view-currency"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Amount</div>
          <div class="detail-value mono" id="cl-view-amount"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Committed</div>
          <div class="detail-value" id="cl-view-committed"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Status</div>
          <div class="detail-value" id="cl-view-status"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Start Date</div>
          <div class="detail-value" id="cl-view-start"></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">End Date</div>
          <div class="detail-value" id="cl-view-end"></div>
        </div>
        <div class="detail-item full-width">
          <div class="detail-label">Note</div>
          <div class="detail-value" id="cl-view-note"></div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeCLView()">Close</button>
        <button type="button" class="btn-primary" id="cl-view-edit-btn">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 1.5l2 2L4 12H2v-2z"/></svg>
          Edit
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="cl-panel">
  <div class="modal-box" style="width: 520px; max-height: 90vh; overflow-y: auto;">
    <h3>
      <span id="cl-panel-title">New Credit Line</span>
      <button class="panel-close" onclick="closeCLForm()">&times;</button>
    </h3>
    <form id="cl-form" onsubmit="saveCL(event)">
      <input type="hidden" id="cl-edit-id" value="" />
      <div class="form-group">
        <label>Bank</label>
        <select id="cl-bank" required>
          <option value="">Select bank...</option>
          {% for bank in banks %}
          <option value="{{ bank.bank_key }}">{{ bank.bank_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="cl-description" placeholder="e.g. Syndicated Facility" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Currency</label>
          <div class="select-with-add">
            <select id="cl-currency" required>
              {% for curr in currencies %}
              <option value="{{ curr.code }}">{{ curr.code }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn-add-currency" onclick="openCurrencyModal()" title="Add currency">+</button>
          </div>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="text" id="cl-amount" required placeholder="e.g. 510,000,000" oninput="formatCLAmount(this)" inputmode="numeric" />
        </div>
      </div>
      <div class="form-group">
        <label>Committed</label>
        <select id="cl-committed" required>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" id="cl-start" required />
        </div>
        <div class="form-group">
          <label>End Date (optional)</label>
          <input type="date" id="cl-end" />
        </div>
      </div>
      <div class="form-group">
        <label>Note</label>
        <textarea id="cl-note" placeholder="Optional notes..."></textarea>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="closeCLForm()">Cancel</button>
        <button type="submit" class="btn-primary">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2 7 5.5 10.5 12 4"/></svg>
          Save
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const parseNum = window.TDNumber.parseLocaleNumber;

function formatCLAmount(el) {
  window.TDNumber.formatIntegerInput(el);
}

function openCLForm() {
  document.getElementById('cl-panel-title').textContent = 'New Credit Line';
  document.getElementById('cl-form').reset();
  document.getElementById('cl-edit-id').value = '';
  document.getElementById('cl-panel').classList.add('show');
}

function closeCLForm() {
  document.getElementById('cl-panel').classList.remove('show');
}

function closeCLView() {
  document.getElementById('cl-view-modal').classList.remove('show');
}

let currentViewCLId = null;

async function viewCL(id) {
  const res = await fetch('/credit-lines/' + id);
  if (!res.ok) return;
  const data = await res.json();
  currentViewCLId = id;

  document.getElementById('cl-view-title').textContent = id;
  document.getElementById('cl-view-bank').textContent = data.bank_name || data.bank_key;
  document.getElementById('cl-view-description').textContent = data.description || '—';
  document.getElementById('cl-view-currency').innerHTML =
    '<span class="badge badge-' + data.currency.toLowerCase() + '">' + data.currency + '</span>';
  document.getElementById('cl-view-amount').textContent = parseInt(data.amount).toLocaleString();
  document.getElementById('cl-view-committed').textContent = data.committed;
  document.getElementById('cl-view-status').innerHTML = data.archived
    ? '<span class="badge badge-archived">Archived</span>'
    : '<span class="badge badge-active">Active</span>';
  document.getElementById('cl-view-start').textContent = formatDate(data.start_date);
  document.getElementById('cl-view-end').textContent = formatDate(data.end_date);
  document.getElementById('cl-view-note').textContent = data.note || '—';

  // Hide Edit button for archived lines
  document.getElementById('cl-view-edit-btn').style.display = data.archived ? 'none' : '';

  document.getElementById('cl-view-modal').classList.add('show');
}

async function editCL(id) {
  const res = await fetch('/credit-lines/' + id);
  if (!res.ok) return;
  const data = await res.json();
  document.getElementById('cl-panel-title').textContent = 'Edit ' + id;
  document.getElementById('cl-edit-id').value = id;
  document.getElementById('cl-bank').value = data.bank_key;
  document.getElementById('cl-description').value = data.description || '';
  document.getElementById('cl-currency').value = data.currency;
  document.getElementById('cl-amount').value = parseInt(data.amount).toLocaleString();
  document.getElementById('cl-committed').value = data.committed;
  document.getElementById('cl-start').value = data.start_date;
  document.getElementById('cl-end').value = data.end_date || '';
  document.getElementById('cl-note').value = data.note || '';
  document.getElementById('cl-panel').classList.add('show');
}

// "Edit" button inside view mode — close view, open edit
document.getElementById('cl-view-edit-btn').addEventListener('click', function() {
  if (currentViewCLId) {
    closeCLView();
    editCL(currentViewCLId);
  }
});

// Row click → open view mode (skip clicks on action buttons)
document.getElementById('cl-table').addEventListener('click', function(e) {
  if (e.target.closest('.row-actions')) return;
  const row = e.target.closest('tr[data-id]');
  if (row) viewCL(row.dataset.id);
});

async function saveCL(e) {
  e.preventDefault();
  const data = {
    bank_key: document.getElementById('cl-bank').value,
    description: document.getElementById('cl-description').value,
    currency: document.getElementById('cl-currency').value,
    amount: parseNum(document.getElementById('cl-amount').value),
    committed: document.getElementById('cl-committed').value,
    start_date: document.getElementById('cl-start').value,
    end_date: document.getElementById('cl-end').value || null,
    note: document.getElementById('cl-note').value || null,
  };
  const id = document.getElementById('cl-edit-id').value;
  const url = id ? '/credit-lines/' + id : '/credit-lines';
  const method = id ? 'PUT' : 'POST';
  const res = await fetch(url, {
    method,
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  if (res.ok) location.reload();
}

// Auto-open form if ?new=1
if (new URLSearchParams(window.location.search).get('new')) {
  openCLForm();
  history.replaceState(null, '', '/credit-lines');
}

async function archiveCL(id) {
  if (!confirm('Archive credit line ' + id + '?')) return;
  const res = await fetch('/credit-lines/' + id, { method: 'DELETE' });
  if (res.ok) location.reload();
}

async function restoreCL(id) {
  const res = await fetch('/credit-lines/' + id + '/restore', { method: 'PATCH' });
  if (res.ok) location.reload();
}

function filterCLs(filter, pill) {
  document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
  pill.classList.add('active');
  const rows = document.querySelectorAll('#cl-table tbody tr[data-archived]');
  rows.forEach(row => {
    const archived = row.dataset.archived === 'true';
    if (filter === 'all') { row.style.display = ''; }
    else if (filter === 'active') { row.style.display = archived ? 'none' : ''; }
    else if (filter === 'archived') { row.style.display = archived ? '' : 'none'; }
  });
  // Update count in header
  let visible = 0;
  rows.forEach(r => { if (r.style.display !== 'none') visible++; });
  const h3 = document.querySelector('.section-header h3');
  const label = filter === 'all' ? 'All Credit Lines' : filter === 'archived' ? 'Archived Credit Lines' : 'Credit Lines';
  h3.textContent = label + ' (' + visible + ')';
}
</script>
{% endblock %}
